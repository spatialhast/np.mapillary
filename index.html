<!DOCTYPE html>
<html>
<head>
	<title>NP@Mapillary 2015</title>
	
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="description" content="Analyzing OpenStreetMap tile map access logs data in Ukraine">
	<meta name="keywords" content="data, visualization, geospatial, geo, spatial, OpenStreetMap, OSM, tile logs">
	<link rel="shortcut icon" href="assets/icon.png">

	<link rel="stylesheet" href="assets/leaflet-0.7.7/leaflet.css" />
	<link rel="stylesheet" href="assets/bootstrap-3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/bootstrap-table/bootstrap-table.min.css">	
	<link rel="stylesheet" href="assets/font-awesome-4.2.0/css/font-awesome.min.css">		

	<style>
		body {
			padding: 0;
			margin: 0;
		}
		html, body, #map {
			height: 100%;
			width: 100%;
		}	
	</style>

</head>

<body>

	<div id="map" class="map"></div>

	<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title">NP@Mapillary 2015</h4>
				</div>
				<div class="modal-body">

					<p>Конкурс геотегованих фото ПЗФ</p>

					<p><a href="http://wiki.openstreetmap.org/wiki/Uk:NP@Mapillary_2015">Cторінка на сайті OpenStreetMap Wiki</a>, <a href="http://forum.openstreetmap.org/viewtopic.php?id=40906">Cторінка на форумі OpenStreetMap</a></p>
					<br>
					<p>Статистика зібраних фотографій у проміжок часу 15.09.2015 - 15.12.2015 в межах ПЗФ:</p>
					<table data-toggle="table" data-url="data/data.json" data-cache="false" data-height="auto">
						<thead>
							<tr>
								<th data-field="place" data-formatter="placeNumber">Місце</th>
								<th data-field="name" data-formatter="linkUserName">Mapillary профіль</th>
								<th data-field="paname" data-formatter="panameReplace">Об'єкти ПЗФ</th>
								<th data-field="count">Кількість фото</th>
							</tr>
						</thead>
					</table>
					<br>
					<p>Загальна статистика зібраних фотографій в межах ПЗФ:</p>
					<table data-toggle="table" data-url="data/data_full.json" data-cache="false" data-height="auto">
						<thead>
							<tr>
								<th data-field="name" data-formatter="linkUserName">Mapillary профіль</th>
								<th data-field="paname" data-formatter="panameReplace">Об'єкти ПЗФ</th>
								<th data-field="count">Кількість фото</th>
							</tr>
						</thead>
					</table>	
					
					<p><small>Оновлено: 01.11.2015 (оновлення виконується раз на тиждень)</small></p>
					
					<p>Для перегляду кордонів ПЗФ та покриття <a href="https://www.mapillary.com/">Mapillary</a> закрийте поточне вікно і перейдіть до карти. Межі ПЗФ взяті з проекту <a href="https://www.openstreetmap.org/">OpenStreetMap</a>. Для перегляду об'єкту ПЗФ на сторінці OpenStreetMap на обраному полігоні клікніть мишкою два рази.</p>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<script src="assets/jquery-2.0.0.min.js"></script>
	<script src="assets/leaflet-0.7.7/leaflet.js"></script>
	<script src="assets/bootstrap-3.3.5/js/bootstrap.min.js"></script>
	<script src="assets/bootstrap-table/bootstrap-table.min.js"></script>
	<script src="assets/leaflet.easybutton/easy-button.js"></script>	
	<script src="assets/leaflet-hash.js"></script>	
	<script src="assets/Leaflet.MapboxVectorTile.min.js"></script>	

	<script>

$("#aboutModal").modal("show");

function placeNumber(value, row, index) {
	return 1 + index;
};

function linkUserName(value, row) {
	return '<a href="https://www.mapillary.com/profile/' + value + '">' + value + '</a>';
};

function panameReplace(value, row, index) {
	return JSON.stringify(value).replace(/","/g, ', ').slice(2, -2);
};

var layerOSM = L.tileLayer('http://{s}.tiles.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IlhHVkZmaW8ifQ.hAMX5hSW-QnTeRCMAy9A8Q', {
	attribution: 'Map style &copy; <a href="https://www.mapbox.com/about/maps/">MapBox</a>; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
});

var map = new L.Map('map', {
	layers: [layerOSM],
	minZoom: 6,
	maxZoom: 18,
	zoom: 7, 
	center: [48.6, 32.2],
	maxBounds: new L.LatLngBounds(new L.LatLng(43.9655, 12.4158), new L.LatLng(53.0720, 52.0862))
});

L.easyButton('fa-list-ul',
	function() {
		$('#aboutModal').modal('show');
		return false;
	},
	'About the map'
	).addTo(map);

var hash = new L.Hash(map);

var nature_conservation_polygon = L.geoJson(null, {
	style: function(feature) {
		if (feature.properties.name === null) {
			return {
				color: "#ff4c4c",
				fill: true,
				opacity: 0.7,
				weight: 2
			};
		} else
		return {
			color: "#9ace00",
			fill: true,
			opacity: 0.7,
			weight: 2
		};
	},
	onEachFeature: function(feature, layer_nature_conservation_polygon) {
		layer_nature_conservation_polygon.on({
			dblclick: function(e) {
				var url = 'http://www.openstreetmap.org/' + (feature.properties.osm_id < 0 ? 'relation/' + feature.properties.osm_id * (-1) : 'way/' + feature.properties.osm_id);
				window.open(url);
			}
		});
	}
});
$.getJSON("data/nature_conservation_polygon.geojson", function(data) {
	nature_conservation_polygon.addData(data);
});	
nature_conservation_polygon.addTo(map);	

var debug = {};
var mvtSource = new L.TileLayer.MVTSource({
	url: "http://d2munx5tg0hw47.cloudfront.net/tiles/{z}/{x}/{y}.mapbox",
	debug: false,
	clickableLayers: ["mapillary-sequences"],
	getIDForLayerFeature: function(feature) {
  //console.log(feature.properties);
  return feature.properties.key;
},
filter: function(feature, context) {
	if (feature.layer.name === 'mapillary-sequences') {
		return true;
	}
	return false;
},

style: function (feature) {
	var style = {};
	style.color = 'rgba(161,217,155,0.9)';
	style.size = 3;
	style.selected = {
		color: 'rgba(255,25,0,0.5)',
		size: 4
	};
	return style;
}

});
debug.mvtSource = mvtSource;

//Globals that we can change later.
var fillColor = 'rgba(149,139,255,0.4)';
var strokeColor = 'rgb(20,20,20)';

//Add layer
map.addLayer(mvtSource);

</script>

</body>
</html>
